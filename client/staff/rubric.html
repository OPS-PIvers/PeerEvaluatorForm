<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cache Control Headers -->
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    
    <!-- Content Security Policy - Allow framing from any origin -->
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors *;">

    <!-- App Metadata -->
    <meta name="application-name" content="Danielson Framework">
    <meta name="author" content="<?= SYSTEM_INFO.AUTHOR ?>">
    <meta name="generator" content="Google Apps Script">
    <meta name="robots" content="noindex, nofollow">

    <!-- Read-only rubric - no Quill.js needed -->

    <!-- Response Metadata (from server) -->
    <? if (data.userContext && data.userContext.responseMetadata) { ?>
        <meta name="x-request-id" content="<?= data.userContext.responseMetadata.requestId ?>">
        <meta name="x-timestamp" content="<?= data.userContext.responseMetadata.timestamp ?>">
        <meta name="x-cache-version" content="<?= data.userContext.responseMetadata.cacheVersion ?>">
        <meta name="x-etag" content="<?= data.userContext.responseMetadata.etag ?>">
        <meta name="x-role" content="<?= data.userContext.role ?>">
        <meta name="x-year" content="<?= data.userContext.year ?>">

        <? if (data.userContext.debugMode) { ?>
            <meta name="x-debug-mode" content="true">
            <meta name="x-user-email" content="<?= data.userContext.email || 'anonymous' ?>">
            <meta name="x-user-authenticated" content="<?= data.userContext.isAuthenticated ?>">
            <meta name="x-role-override" content="<?= data.userContext.isRoleOverride || false ?>">
        <? } ?>
    <? } ?>

    <!-- Dynamic Title -->
    <title><?= data.title ?> - <?= data.userContext ? data.userContext.role : 'Framework' ?></title>

    <!-- Prevent browser back/forward cache -->
    <meta name="turbo-cache-control" content="no-cache">

    <style>
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #dc3545;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-20px);
    transition: all 0.3s ease-in-out;
}

.toast-notification.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
:root {
    --color-white: white;
    --color-text-default: #333;
    --color-bg-body: #f5f5f5;

    /* Greens for toggle button and assignments */
    --color-green-base: #10b981;
    --color-green-dark: #059669;
    --color-green-darker: #047857;
    --color-green-light-bg: #f0fdf4;

    /* Ambers for toggle button (assigned mode) and active filters */
    --color-amber-base: #f59e0b;
    --color-amber-dark: #d97706;
    --color-amber-darker: #b45309;
    --color-amber-light-bg: #fef3c7;
    --color-amber-text-dark: #92400e;

    /* Blues for filter status and select focus */
    --color-blue-base: #3b82f6;
    --color-blue-light-bg: #dbeafe;
    --color-blue-text-dark: #1e40af;
    --color-blue-focus-shadow: rgba(59, 130, 246, 0.1);

    /* Grays for various UI elements */
    --color-gray-text: #4a5568;
    --color-gray-text-light: #374151;
    --color-gray-border-light: #d1d5db;
    --color-gray-border-medium: #e2e8f0;
    --color-gray-bg-light: #f8fafc;
    --color-gray-bg-medium: #6b7280;
    --color-gray-bg-dark: #4b5563;
    --color-gray-component-not-assigned-border: #e5e7eb;
    --color-gray-assignment-indicator-not-assigned-bg: #e5e7eb;
    --color-text-deemphasized: #718096;
}

.error-container {
    padding: 40px;
    text-align: center;
    color: #D8000C; /* Standard error text color */
    background-color: #FFBABA; /* Light red background for errors */
    border: 1px solid #D8000C; /* Standard error border color */
    border-radius: 5px;
    margin: 10px;
}

.error-title {
    color: #D8000C; /* Ensure title also uses the error text color */
    /* Any other h3-specific styles for the error title can go here if needed */
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--color-text-default);
            background-color: var(--color-bg-body);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .navigation {
            background: #e2e8f0;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid #cbd5e0;
            // position: sticky;
            top: 0;
            z-index: 60;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-button {
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .nav-button:hover {
            background: #2d3748;
        }
        
        .nav-button.active {
            background: #3182ce;
        }
        
        .domain-section {
            border-bottom: 3px solid #e2e8f0;
        }
        
        .domain-header {
            background: linear-gradient(135deg, #7c9ac5, #5a82b8);
            color: white;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .component-section {
            border-bottom: 1px solid var(--color-gray-border-medium);
            position: relative;
        }
        
        .performance-levels-header {
            position: sticky;
            top: 56px;
            z-index: 40;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .performance-levels {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr 1fr;
            min-height: 50px;
        }
        
        .performance-levels-content {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr 1fr;
            min-height: 120px;
        }
        
        .level-header {
            background: #e2e8f0;
            padding: 12px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid #cbd5e0;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .level-content.rating-cell {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .level-content.rating-cell:hover {
            background-color: #f0f4f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .level-content.rating-cell.selected {
            background-color: var(--color-blue-light-bg);
            border-color: var(--color-blue-base);
            color: var(--color-blue-text-dark);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
            border-left: 3px solid var(--color-blue-base);
        }
        
        .level-content {
            padding: 20px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        .level-content:last-child {
            border-right: none;
        }
        
        .row-label {
            background: #64748b;
            padding: 20px;
            font-weight: 600;
            color: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .look-fors-section {
            border-top: 1px solid #e2e8f0;
        }
        
        .look-fors-header {
            background: linear-gradient(135deg, #3182ce, #2b77cb);
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.3s ease;
            font-size: 0.85rem;
        }
        
        .look-fors-header:hover {
            background: linear-gradient(135deg, #2b77cb, #2c5aa0);
        }
        
        .chevron {
            transition: transform 0.3s ease;
            font-size: 1rem;
        }
        
        .chevron.expanded {
            transform: rotate(180deg);
        }
        
        .look-fors-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f8fafc;
        }
        
        .look-fors-content.expanded {
            max-height: 250px;
        }
        
        .look-fors-grid {
            padding: 12px 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .look-for-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            border-left: 3px solid #3182ce;
        }
        
        .look-for-item input[type="checkbox"] {
            margin-top: 2px;
            transform: scale(1.1);
            accent-color: #3182ce;
        }
        
        .look-for-item label {
            cursor: pointer;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background: #2c5aa0;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-button {
                width: 100%;
                max-width: 300px;
                margin-bottom: 5px;
            }
            
            .performance-levels, .performance-levels-content {
                grid-template-columns: 1fr;
                gap: 1px;
            }
            
            .level-header, .row-label, .level-content {
                border-right: none;
                padding: 15px;
            }
            
            .level-header {
                font-size: 0.8rem;
            }
            
            .row-label {
                font-size: 0.8rem;
            }
            
            .level-content {
                font-size: 0.8rem;
            }
            
            .navigation {
            //    position: sticky;
            //    top: 0;
            //    z-index: 60;
                  display: none;
            }

            .domain-header {
                position: sticky;
                top: 0;
                z-index: 50;
            }

            .performance-levels-header {
                position: sticky;
                top: 56px;
                z-index: 40;
            }
        }

        /* Debug info styles (only visible in debug mode) */
        <? if (data.userContext && data.userContext.debugMode) { ?>
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
            z-index: 9999;
            max-width: 300px;
            word-break: break-all;
        }

        .debug-info h4 {
            margin-bottom: 8px;
            color: #ffc107;
        }

        .debug-info div {
            margin-bottom: 4px;
        }
        <? } ?>

        /* Floating Navigation Widget */
        .floating-nav {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .floating-nav.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .floating-nav-button {
            background: #3182ce;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .floating-nav-button:hover {
            background: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .nav-icon {
            font-size: 1.1rem;
            line-height: 1;
        }

        .nav-text {
            font-size: 0.85rem;
        }

        .floating-nav-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            margin-top: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            min-width: 180px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .floating-nav-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .floating-nav-item {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            color: #4a5568;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .floating-nav-item:last-child {
            border-bottom: none;
        }

        .floating-nav-item:hover {
            background: #f8fafc;
            color: #3182ce;
        }

        .floating-nav-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .floating-nav-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .floating-nav {
                top: 15px;
                left: 15px;
            }
            
            .floating-nav-button {
                padding: 8px 12px;
                min-width: 100px;
                font-size: 0.8rem;
            }
            
            .floating-nav-menu {
                min-width: 160px;
                max-height: 50vh;
            }
            
            .floating-nav-item {
                padding: 10px 14px;
                font-size: 0.85rem;
            }
        }

        /* View Toggle Button Styles */
        .view-toggle-container {
            margin-top: 15px;
        }

        .view-toggle-btn {
            background: linear-gradient(135deg, var(--color-green-base), var(--color-green-dark));
            color: var(--color-white);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .view-toggle-btn:hover {
            background: linear-gradient(135deg, var(--color-green-dark), var(--color-green-darker));
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .view-toggle-btn.assigned-mode {
            background: linear-gradient(135deg, var(--color-amber-base), var(--color-amber-dark));
        }

        .view-toggle-btn.assigned-mode:hover {
            background: linear-gradient(135deg, var(--color-amber-dark), var(--color-amber-darker));
        }

        /* Special Role Filter Styles */
        .special-filters {
            background: var(--color-gray-bg-light);
            border: 2px solid var(--color-gray-border-medium);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-label {
            font-weight: 600;
            color: var(--color-gray-text);
            margin-right: 10px;
        }

        .filter-select {
            background: var(--color-white);
            border: 1px solid var(--color-gray-border-light);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--color-gray-text-light);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--color-blue-base);
            box-shadow: 0 0 0 3px var(--color-blue-focus-shadow);
        }

        .filter-btn {
            background: var(--color-gray-bg-medium);
            color: var(--color-white);
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .filter-btn:hover {
            background: var(--color-gray-bg-dark);
        }

        .domain-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Filter Status Indicator */
        .filter-status {
            background: var(--color-blue-light-bg);
            border: 1px solid var(--color-blue-base);
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 15px;
            color: var(--color-blue-text-dark);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-status.active {
            background: var(--color-amber-light-bg);
            border-color: var(--color-amber-base);
            color: var(--color-amber-text-dark);
        }

        .filter-status-detail {
            margin-left: 15px;
            font-size: 0.8rem;
        }

        /* Component Assignment Indicators */
        .component-section.component-assigned {
            border-left: 4px solid var(--color-green-base);
            background: var(--color-green-light-bg);
        }

        .component-section.component-not-assigned {
            background: var(--color-gray-bg-light);
            border-left: 4px solid var(--color-gray-component-not-assigned-border);
        }

        .component-section.component-not-assigned .level-content,
        .component-section.component-not-assigned .look-for-item label {
            color: var(--color-text-deemphasized);
        }

        .assignment-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--color-green-base);
            color: var(--color-white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .assignment-indicator.not-assigned {
            background: var(--color-gray-assignment-indicator-not-assigned-bg);
            color: var(--color-gray-bg-medium);
        }

        .assigned-badge {
            background-color: var(--color-blue-light-bg);
            color: var(--color-blue-text-dark);
            padding: 0.2em 0.6em;
            border-radius: 0.25rem;
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: 500;
            vertical-align: middle;
            display: inline-block;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-select {
                min-width: auto;
                width: 100%;
                margin-bottom: 5px;
            }

            .view-toggle-btn {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }

            .domain-nav {
                flex-direction: column;
            }

            .nav-button {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        .component-hidden {
            display: none;
        }

        .indicator-hidden {
            display: none;
        }

        /* Hover effect for assigned components */
        .component-section[data-assigned="true"]:hover {
            border-left-color: var(--color-green-dark);
            background-color: var(--color-green-light-bg);
        }

        /* Hover effect for not-assigned components */
        .component-section[data-assigned="false"]:hover,
        .component-section:not([data-assigned]):hover { /* Handles components not explicitly marked false initially */
            border-left-color: var(--color-gray-border-light);
            background-color: var(--color-gray-bg-light);
        }

        .assignment-counter-styles {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-left: 10px;
        }

        /* Media Upload Styles */
        .media-upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #f0f4f8;
            border-top: 1px solid #e2e8f0;
            margin-top: 10px;
        }

        .media-upload-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }

        .media-upload-button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .media-upload-button:hover {
            background: #2c5aa0;
        }

        .media-links-container {
            padding: 10px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .media-link-item {
            margin-bottom: 5px;
        }

        .media-link-item a {
            color: #3182ce;
            text-decoration: none;
        }

        .media-link-item a:hover {
            text-decoration: underline;
        }

        /* Evidence Section Styles */
        .evidence-section {
            margin-top: 10px;
        }

        .evidence-toggle-btn {
            background: linear-gradient(135deg, #4a4a4a, #3a3a3a);
            color: white;
            border: none;
            padding: 10px 20px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .evidence-toggle-btn:hover {
            background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
        }

        .evidence-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f8fafc;
        }

        .evidence-content.expanded {
            max-height: 800px;
        }


        .notes-container {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .notes-container h4 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .look-fors-container {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .look-fors-container h4 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Quill Editor Styling */
        [id^="notes-editor-"] {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            min-height: 120px;
        }

        .ql-toolbar {
            border-top: 1px solid #d1d5db;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .ql-container {
            border-bottom: 1px solid #d1d5db;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* Landing Page Styles */
        .landing-page {
            padding: 40px 30px;
        }
        
        /* Modern Action Cards Styling */
        .quick-actions { 
            margin-bottom: 40px; 
        }
        .section-title {
            color: #374151;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .action-card {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .action-card:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .action-icon { 
            font-size: 2.5rem; 
            margin-bottom: 15px; 
            display: block; 
        }
        .action-title { 
            font-weight: 600; 
            color: #1f2937; 
            font-size: 1.1rem; 
            margin-bottom: 8px; 
        }
        .action-desc { 
            color: #6b7280; 
            font-size: 0.95rem; 
        }
        
        /* Legacy button styles (for back button etc.) */
        .landing-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 10px;
            transition: background 0.3s ease;
        }
        .landing-btn:hover {
            background: #2c5aa0;
        }
        .observations-container {
            margin-top: 20px;
        }
        .observation-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: left;
            cursor: pointer;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        .observation-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .observation-card h3 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        .observation-card p {
            color: #4a5568;
            font-size: 0.9rem;
        }

        /* Read-only mode styles */
        .read-only .rating-cell,
        .read-only .look-for-item input,
        .read-only .media-upload-button,
        .read-only .filter-select,
        .read-only .filter-btn:not(#workProductQuestionsBtn) {
            pointer-events: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .read-only .ql-editor {
            background-color: #f5f5f5;
        }

        /* View Mode Toggle Styles */
        .view-toggle-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .view-toggle-switch {
            position: relative;
            display: inline-flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .toggle-option {
            position: relative;
            z-index: 2;
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
            border-radius: 6px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .toggle-option:hover {
            color: #334155;
            background: rgba(100, 116, 139, 0.08);
        }

        .toggle-option.active {
            background: var(--color-blue-base);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.2);
        }

        .toggle-option.active:hover {
            background: var(--color-blue-text-dark);
            color: white;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            background: linear-gradient(135deg, var(--color-blue-base), var(--color-blue-text-dark));
            border-radius: 6px;
            box-shadow: 0 3px 12px rgba(30, 64, 175, 0.3), 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Observations Button */
        .observations-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            margin-left: 15px;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .observations-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: #f8fafc;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .modal-content {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .loading-message, .empty-message {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .empty-message h3 {
            color: #475569;
            margin-bottom: 8px;
        }

        .empty-message p {
            color: #64748b;
            font-size: 0.95rem;
        }

        /* Observation Cards */
        .observation-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .observation-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .observation-card h3 {
            margin: 0 0 12px 0;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .observation-meta {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .file-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .file-card:hover {
            background: #e2e8f0;
            border-color: #3b82f6;
            transform: translateY(-2px);
            text-decoration: none;
            color: inherit;
        }

        .file-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .file-size {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .landing-btn.back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #64748b;
        }
        .landing-btn.back-btn:hover {
            background: #4a5568;
        }
        
        /* Responsive Styles for Action Cards */
        @media (max-width: 768px) {
            .landing-page {
                padding: 20px;
            }
            .actions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .action-card {
                padding: 20px;
            }
            .action-icon {
                font-size: 2rem;
            }
            .section-title {
                font-size: 1.1rem;
            }
        }

        /* Professional Welcome Modal Styles */
        .welcome-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            padding: 20px;
            box-sizing: border-box;
        }

        .welcome-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .welcome-modal {
            background: var(--color-white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(30px) scale(0.9);
            transition: all 0.4s ease;
        }

        .welcome-modal-overlay.show .welcome-modal {
            transform: translateY(0) scale(1);
        }

        .welcome-modal-header {
            background: linear-gradient(135deg, var(--color-blue-base), #2563eb);
            color: var(--color-white);
            padding: 40px 30px 30px;
            text-align: center;
            position: relative;
        }

        .welcome-modal-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            animation: welcomeIconPulse 2s ease-in-out infinite;
        }

        @keyframes welcomeIconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .welcome-modal-header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
            margin: 0;
        }

        .welcome-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            line-height: 1.6;
        }

        .welcome-section {
            margin-bottom: 30px;
        }

        .welcome-feature {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid var(--color-blue-base);
            transition: all 0.3s ease;
        }

        .welcome-feature:hover {
            background: var(--color-blue-light-bg);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);
        }

        .feature-icon {
            font-size: 2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .feature-content h3 {
            color: var(--color-gray-text-light);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .feature-content p {
            color: var(--color-gray-text);
            font-size: 0.95rem;
            margin: 0;
        }

        .welcome-commitment {
            background: linear-gradient(135deg, var(--color-green-light-bg), var(--color-blue-light-bg));
            border: 2px solid var(--color-green-base);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .welcome-commitment h3 {
            color: var(--color-green-darker);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .welcome-commitment p {
            color: var(--color-gray-text-light);
            font-size: 1rem;
            margin: 0;
            font-style: italic;
        }

        .welcome-modal-footer {
            padding: 25px 30px;
            background: #f8fafc;
            border-top: 1px solid #d1d5db;
            text-align: center;
        }

        .welcome-continue-btn {
            background: linear-gradient(135deg, var(--color-green-base), var(--color-green-dark));
            color: var(--color-white);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            min-width: 280px;
        }

        .welcome-continue-btn:hover {
            background: linear-gradient(135deg, var(--color-green-dark), var(--color-green-darker));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .welcome-continue-btn .btn-icon {
            font-size: 1.2rem;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .welcome-modal-overlay {
                padding: 15px;
            }
            
            .welcome-modal {
                max-width: 100%;
                border-radius: 12px;
            }
            
            .welcome-modal-header {
                padding: 30px 20px 25px;
            }
            
            .welcome-modal-header h1 {
                font-size: 1.5rem;
            }
            
            .welcome-subtitle {
                font-size: 1rem;
            }
            
            .welcome-modal-content {
                padding: 20px;
            }
            
            .welcome-feature {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .feature-icon {
                align-self: center;
            }
            
            .welcome-continue-btn {
                min-width: 250px;
                font-size: 1rem;
            }
        }

        .work-product-question {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #fafafa;
        }

        .work-product-question-text {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .work-product-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .work-product-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .work-product-textarea:disabled {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: wait;
            opacity: 0.8;
        }

        .save-status {
            font-size: 0.8rem;
            margin-top: 5px;
            transition: opacity 0.3s ease;
        }

        .save-status.saving {
            color: #f59e0b;
        }

        .save-status.saved {
            color: #10b981;
        }

        .save-status.error {
            color: #ef4444;
        }

        /* Filter Button Base Styles */
        .filter-btn {
            background: var(--color-blue-base);
            color: white;
            border: 2px solid var(--color-blue-base);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .filter-btn:hover:not(:disabled) {
            background: #2c5aa0;
            border-color: #2c5aa0;
        }

        .filter-btn:disabled {
            background: #cbd5e0;
            border-color: #cbd5e0;
            cursor: not-allowed;
        }

        /* Work Product Button State Styles */
        .wp-not-started {
            background: linear-gradient(135deg, #6b7280, #9ca3af) !important;
            color: white !important;
        }

        .wp-in-progress {
            background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
            color: white !important;
            animation: pulse-progress 2s infinite;
        }

        .wp-submitted {
            background: linear-gradient(135deg, #059669, #10b981) !important;
            color: white !important;
        }

        .wp-state-text {
            font-size: 0.85rem;
            font-weight: normal;
            margin-left: 8px;
            opacity: 0.9;
        }

        @keyframes pulse-progress {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- Professional Welcome Modal -->
    <div class="welcome-modal-overlay" id="welcomeModalOverlay">
        <div class="welcome-modal" id="welcomeModal">
            <div class="welcome-modal-header">
                <div class="welcome-modal-icon">🌟</div>
                <h1>Welcome to the Observation Resources Website</h1>
                <p class="welcome-subtitle">Your Professional Growth Journey Begins Here</p>
            </div>
            
            <div class="welcome-modal-content">
                <div class="welcome-section">
                    <div class="welcome-feature">
                        <span class="feature-icon">📈</span>
                        <div class="feature-content">
                            <h3>Continuous Professional Development</h3>
                            <p>This platform is designed to support your ongoing professional growth through reflective observation and evidence-based feedback. Every interaction is an opportunity to enhance your teaching practice.</p>
                        </div>
                    </div>
                    
                    <div class="welcome-feature">
                        <span class="feature-icon">🤝</span>
                        <div class="feature-content">
                            <h3>Collaborative Learning Environment</h3>
                            <p>Engage in meaningful peer observations and receive constructive feedback that supports your development. Our framework promotes collegiality and shared expertise among educational professionals.</p>
                        </div>
                    </div>
                    
                    <div class="welcome-feature">
                        <span class="feature-icon">🎯</span>
                        <div class="feature-content">
                            <h3>Evidence-Based Growth</h3>
                            <p>Utilize comprehensive rubrics and structured observation tools to identify strengths and areas for growth. Transform observations into actionable insights for improved student outcomes.</p>
                        </div>
                    </div>
                    
                    <div class="welcome-feature">
                        <span class="feature-icon">✨</span>
                        <div class="feature-content">
                            <h3>Inspiring Excellence</h3>
                            <p>This experience is designed to be supportive, inspiring, and focused on celebrating your professional journey. Every observation is a step toward educational excellence.</p>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-commitment">
                    <h3>Our Commitment to You</h3>
                    <p>We are dedicated to providing a positive, growth-oriented experience that recognizes your professionalism and supports your continued development as an educator. This tool represents our investment in your success and the success of all learners in our community.</p>
                </div>
            </div>
            
            <div class="welcome-modal-footer">
                <button class="welcome-continue-btn" onclick="closeWelcomeModal()">
                    <span class="btn-icon">🚀</span>
                    Continue Growing in My Profession
                </button>
            </div>
        </div>
    </div>
    
    <div id="toastNotification" class="toast-notification"></div>
    <!-- Debug Information (only visible in debug mode) -->
    <? if (data.userContext && data.userContext.debugMode) { ?>
    <div class="debug-info">
        <h4>🐛 DEBUG INFO</h4>
        <div><strong>Role:</strong> <?= data.userContext.role ?></div>
        <div><strong>Year:</strong> <?= data.userContext.year ?></div>
        <div><strong>Email:</strong> <?= data.userContext.email || 'Anonymous' ?></div>
        <div><strong>Cache Ver:</strong> <?= data.userContext.cacheVersion ?></div>
        <div><strong>Request ID:</strong> <?= data.userContext.requestId ?></div>
        <div><strong>Timestamp:</strong> <?= new Date(data.userContext.timestamp).toLocaleTimeString() ?></div>
        <? if (data.userContext.isRoleOverride) { ?>
        <div style="color: #ffc107;"><strong>⚠️ ROLE OVERRIDE ACTIVE</strong></div>
        <? } ?>
    </div>
    <? } ?>

    <!-- Landing page removed - starting directly in rubric view -->

    <div id="rubricView">
        <div class="container">
            <div class="header">
                <? if (data.userContext && data.userContext.isMyOwnRubricView) { ?>
                <button class="landing-btn back-btn" onclick="backToLandingPage()" style="margin-bottom: 10px;">
                    ← Back to Landing Page
                </button>
                <? } ?>
                <h1><?= data.title ?></h1>
                <p><?= data.subtitle ?></p>
                <!-- View Mode Toggle (always available for reference viewing) -->
                <div class="view-toggle-container">
                    <div class="view-toggle-switch">
                        <button id="assignedToggle" class="toggle-option" onclick="setViewMode('assigned')">
                            📋 Assigned Areas
                        </button>
                        <button id="fullToggle" class="toggle-option" onclick="setViewMode('full')">
                            📚 Full Rubric
                        </button>
                        <div id="toggleSlider" class="toggle-slider"></div>
                    </div>
                    <!-- My Observations Button -->
                    <button id="myObservationsBtn" class="observations-btn" onclick="openObservationsModal()" style="display: none;">
                        📄 My Observations
                    </button>
                    <!-- Work Product Questions Button -->
                    <? if (showWorkProductQuestionsButton) { ?>
                    <button id="workProductQuestionsBtn" onclick="openWorkProductModal()"
                            class="filter-btn wp-<?= workProductState ?>"
                            style="padding: 12px 24px; font-size: 1.1rem;">
                        📋 Work Product Questions
                        <span class="wp-state-text">
                            <? if (workProductState === 'not-started') { ?>(Not Started)<? } ?>
                            <? if (workProductState === 'in-progress') { ?>(In Progress)<? } ?>
                            <? if (workProductState === 'submitted') { ?>(Submitted)<? } ?>
                        </span>
                    </button>
                    <? } ?>
                </div>
            </div>

            <!-- Filter Status (for special roles) -->
            <? if (data.userContext && data.userContext.isFiltered) { ?>
            <div class="filter-status active">
                <strong>👁️ Viewing as:</strong> <?= data.userContext.filterInfo.viewingAs ?>
                (<?= data.userContext.filterInfo.viewingRole ?>, Year <?= data.userContext.filterInfo.viewingYear ?>)
                <span class="filter-status-detail">
                    Requested by: <?= data.userContext.filterInfo.requestedBy ?>
                </span>
            </div>
            <? } else if (data.userContext && data.userContext.hasSpecialAccess && !data.userContext.isMyOwnRubricView) { ?>
            <div class="filter-status">
                <strong>🔧 Special Access Mode:</strong> <?= data.userContext.specialRoleType ? data.userContext.specialRoleType.replace('_', ' ').toUpperCase() : data.userContext.role ?>
                <span class="filter-status-detail">
                    Use filters above to view other staff members' assigned areas
                </span>
            </div>
            <? } ?>

            <div class="navigation">
                <!-- Special Role Filters -->
                <? if (data.userContext && data.userContext.hasSpecialAccess && !data.userContext.isMyOwnRubricView) { ?>
                <div class="special-filters">
                    <div class="filter-section">
                        <span class="filter-label">Viewing Options:</span>

                        <? if (data.userContext.specialRoleType === 'administrator') { ?>
                        <!-- Administrator: Probationary filter only -->
                        <select id="probationaryFilter" class="filter-select" onchange="applyAdminFilter()" aria-label="Filter by Probationary Status">
                            <option value="all">All Staff</option>
                            <option value="probationary">Probationary Staff Only</option>
                        </select>

                        <? } else if (data.userContext.specialRoleType === 'peer_evaluator' || data.userContext.specialRoleType === 'full_access') { ?>
                        <!-- Peer Evaluator & Full Access: Full filtering options -->
                        <select id="roleFilter" class="filter-select" onchange="handleRoleSelection()" aria-label="Filter by Role">
                            <option value="">Select Role...</option>
                            <option value="Any">Any Role</option>
                            <? for (var r = 0; r < data.userContext.availableRoles?.length || 0; r++) { ?>
                            <option value="<?= data.userContext.availableRoles[r] ?>"><?= data.userContext.availableRoles[r] ?></option>
                            <? } ?>
                        </select>

                        <select id="yearFilter" class="filter-select" onchange="updateAvailableStaff()" aria-label="Filter by Year" style="display: none;">
                            <option value="">Select Year...</option>
                            <option value="Any">Any Year</option>
                            <option value="1">Year 1</option>
                            <option value="2">Year 2</option>
                            <option value="3">Year 3</option>
                            <option value="Probationary">Probationary</option>
                        </select>

                        <select id="staffFilter" class="filter-select" onchange="applyStaffFilter()" aria-label="Filter by Staff Member" style="display: none;">
                            <option value="">Select Staff Member...</option>
                            <!-- Options populated by JavaScript -->
                        </select>

                        <button class="filter-btn" onclick="clearAllFilters()">Clear Filters</button>
                        <? } ?>
                    </div>
                </div>
                <? } ?>

                <!-- Domain Navigation (always visible) -->
                <div class="domain-nav">
                    <? for (var d = 0; d < data.domains.length; d++) { ?>
                        <button class="nav-button" data-domain="<?= d ?>">
                            Domain <?= data.domains[d].number ?>
                        </button>
                    <? } ?>
                </div>
            </div>

            <? for (var domainIdx = 0; domainIdx < data.domains.length; domainIdx++) { ?>
                <div class="domain-section" id="domain-<?= domainIdx ?>">
                    <div class="domain-header">
                        <?= data.domains[domainIdx].name ?>
                    </div>
                    
                    <!-- Sticky column headers for this domain -->
                    <div class="performance-levels-header">
                        <div class="performance-levels">
                            <div class="level-header"></div>
                            <div class="level-header">Developing</div>
                            <div class="level-header">Basic</div>
                            <div class="level-header">Proficient</div>
                            <div class="level-header">Distinguished</div>
                        </div>
                    </div>

                    <? for (var i = 0; i < data.domains[domainIdx].components.length; i++) { ?>
                        <?
                        // Determine if this component should be visible
                        var component = data.domains[domainIdx].components[i];
                        var componentId = '';
                        if (component.title) {
                            // Component titles are expected to start with an ID (e.g., "1a:", "2b:")
                            // which is used for matching against assigned subdomains.
                            var match = component.title.match(/^([1-4][a-fA-F]):/);
                            componentId = match ? match[1] + ':' : '';
                        }

                        var isAssigned = false;
                        // Calculate isAssigned if componentId is valid and subdomains are available.
                        // This is needed for styling in 'full' mode and visibility in 'assigned' mode.
                        if (componentId && data.userContext && data.userContext.assignedSubdomains) {
                            var domainKey = 'domain' + (domainIdx + 1);
                            var assignedList = data.userContext.assignedSubdomains[domainKey] || [];
                            isAssigned = assignedList.indexOf(componentId) !== -1;
                        }

                        // Always render all components, but conditionally hide them for client-side toggle functionality
                        var shouldShow = true;
                        var initiallyHidden = false;
                        
                        // Determine if component should be initially hidden based on viewMode
                        if (data.userContext && data.userContext.viewMode === 'assigned') {
                            // In 'assigned' mode, hide components that are not assigned
                            initiallyHidden = componentId ? !isAssigned : true;
                        }
                        ?>

                        <? if (shouldShow) { ?>
                        <div class="component-section <?= isAssigned ? 'component-assigned' : 'component-not-assigned' ?><?= initiallyHidden ? ' component-hidden' : '' ?>"
                             data-component-id="<?= componentId ?>"
                             data-assigned="<?= isAssigned ? 'true' : 'false' ?>">

                            <!-- Assignment Indicator -->
                            <? if (data.userContext && data.userContext.assignedSubdomains && data.userContext.viewMode === 'full') { ?>
                            <div class="assignment-indicator <?= isAssigned ? 'assigned' : 'not-assigned' ?>" aria-label="<?= isAssigned ? 'Component assigned' : 'Component not assigned' ?>">
                                <?= isAssigned ? '✓' : '○' ?>
                            </div>
                            <? } ?>

                            <div class="performance-levels-content">
                                <div class="row-label">
                                    <?= component.title ?>
                                    <? if (isAssigned && data.userContext.viewMode === 'assigned') { ?>
                                    <span class="assigned-badge">📋 Assigned</span>
                                    <? } ?>
                                </div>
                                <div class="level-content rating-cell" data-component-id="<?= component.componentId ?>" data-rating="developing">
                                    <?= component.developing ?>
                                </div>
                                <div class="level-content rating-cell" data-component-id="<?= component.componentId ?>" data-rating="basic">
                                    <?= component.basic ?>
                                </div>
                                <div class="level-content rating-cell" data-component-id="<?= component.componentId ?>" data-rating="proficient">
                                    <?= component.proficient ?>
                                </div>
                                <div class="level-content rating-cell" data-component-id="<?= component.componentId ?>" data-rating="distinguished">
                                    <?= component.distinguished ?>
                                </div>
                            </div>

                            <? if (component.bestPractices && component.bestPractices.length > 0) { ?>
                            <div class="look-fors-section">
                                <div class="look-fors-header" onclick="toggleLookFors('lookfors-<?= component.componentId ?>')">
                                    <span>Best Practices aligned with 5D+ and PELSB Standards</span>
                                    <span class="chevron" id="chevron-lookfors-<?= component.componentId ?>">▶</span>
                                </div>
                                <div class="look-fors-content" id="lookfors-<?= component.componentId ?>">
                                    <div class="look-fors-grid">
                                        <? for (var j = 0; j < component.bestPractices.length; j++) { ?>
                                            <div class="look-for-item">
                                                <?
                                                    var practiceText = component.bestPractices[j];
                                                    var checkedLookForsForComponent = (data.observation && data.observation.observationData && data.observation.observationData[component.componentId] && data.observation.observationData[component.componentId].lookfors) || [];
                                                    var isChecked = checkedLookForsForComponent.includes(practiceText);
                                                ?>
                                                <input type="checkbox" id="practice-<?= component.componentId ?>-<?= j ?>" <?= isChecked ? 'checked' : '' ?> disabled>
                                                <label for="practice-<?= component.componentId ?>-<?= j ?>"><?= practiceText ?></label>
                                            </div>
                                        <? } ?>
                                    </div>
                                </div>
                            </div>
                            <? } ?>

                            <? if (data.observation && data.observation.observationNotes && data.observation.observationNotes[component.componentId]) { ?>
                            <div class="evidence-section">
                                <button class="evidence-toggle-btn" onclick="toggleEvidenceSection('evidence-<?= component.componentId ?>')">
                                    <span>📝</span> Notes & Evidence
                                </button>
                                <div class="evidence-content" id="evidence-<?= component.componentId ?>">
                                    <div class="notes-container">
                                        <h4>Observation Notes</h4>
                                        <div class="notes-display"><?= data.observation.observationNotes[component.componentId] ?></div>
                                    </div>
<div class="media-links-container"></div>
                                </div>
                            </div>
                            <? } ?>
                        </div>
                        <? } ?>
                    <? } ?>

                    <? if (!data.domains[domainIdx].components || data.domains[domainIdx].components.length === 0) { ?>
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <h3>No components found for <?= data.domains[domainIdx].name ?></h3>
                        <p>Please check your Google Sheet data.</p>
                    </div>
                    <? } ?>
                </div>
            <? } ?>

            <? if (data.isError) { ?>
            <div class="error-container">
                <h3 class="error-title">Error</h3>
                <p><?= data.errorMessage ?></p>
            </div>
            <? } else if (!data.domains || data.domains.length === 0) { ?>
            <div style="padding: 40px; text-align: center; color: #666;">
                <h3>No domains found</h3>
                <p>Please check your Google Sheet data and try refreshing the page.</p>
            </div>
            <? } ?>
        </div>
    </div>

    <button class="back-to-top" id="backToTop" onclick="scrollToTop()">↑</button>
    <div class="floating-nav" id="floatingNav">
        <button class="floating-nav-button" onclick="toggleFloatingNav()">
            <span class="nav-icon">≡</span>
            <span class="nav-text">Domains</span>
        </button>
        <div class="floating-nav-menu" id="floatingNavMenu">
            <? for (var d = 0; d < data.domains.length; d++) { ?>
                <button class="floating-nav-item" onclick="scrollToDomain(<?= d ?>); closeFloatingNav();">
                    Domain <?= data.domains[d].number ?>
                </button>
            <? } ?>
        </div>
    </div>

    <script>
        /**
         * Utility Functions
         */
        function formatYearDisplay(year) {
            // Handle Probationary year (0 or 'Probationary')
            if (year === 0 || year === 'Probationary') {
                return 'Probationary';
            }
            
            // Handle null, undefined, or empty values
            if (year === null || year === undefined || year === '') {
                return 'N/A';
            }
            
            // Return the year as-is for valid numeric years (1, 2, 3)
            return year.toString();
        }

        /**
         * Professional Welcome Modal Functions
         */
        
        // Show the welcome modal on page load (once per session)
        function showWelcomeModal() {
            // Check if modal has been shown this session
            if (sessionStorage.getItem('welcomeModalShown') === 'true') {
                return; // Don't show again this session
            }
            
            const overlay = document.getElementById('welcomeModalOverlay');
            if (overlay) {
                // Small delay to ensure page is fully loaded
                setTimeout(() => {
                    overlay.classList.add('show');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                }, 300);
            }
        }
        
        // Close the welcome modal
        function closeWelcomeModal() {
            const overlay = document.getElementById('welcomeModalOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                document.body.style.overflow = ''; // Restore scrolling
                
                // Mark as shown for this session
                sessionStorage.setItem('welcomeModalShown', 'true');
                
                // Remove from DOM after animation completes
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 400);
            }
        }
        
        // Handle keyboard events for accessibility
        function handleModalKeydown(event) {
            if (event.key === 'Escape') {
                const overlay = document.getElementById('welcomeModalOverlay');
                if (overlay && overlay.classList.contains('show')) {
                    closeWelcomeModal();
                }
            }
        }
        
        // Initialize modal when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard listener for escape key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Show welcome modal after a brief delay
            showWelcomeModal();
            
            // Optional: Close modal if clicking outside (on overlay)
            const overlay = document.getElementById('welcomeModalOverlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    // Only close if clicking directly on the overlay (not the modal content)
                    if (event.target === overlay) {
                        closeWelcomeModal();
                    }
                });
            }
        });

        // Special Role Filter Functions
        function applyAdminFilter() {
            const filterSelect = document.getElementById('probationaryFilter');
            if (!filterSelect) return;

            const filterType = filterSelect.value;
            console.log('Administrator filter applied:', filterType);

            // Build new URL with filter parameter
            const newUrl = generateFilteredURL({ filterType: filterType });
            window.location.href = newUrl;
        }

        function updateAvailableStaff() {
            const roleFilter = document.getElementById('roleFilter');
            const yearFilter = document.getElementById('yearFilter');
            const staffFilter = document.getElementById('staffFilter');

            if (!roleFilter || !yearFilter || !staffFilter) return;

            const selectedRole = roleFilter.value;
            const selectedYear = yearFilter.value;

            console.log('updateAvailableStaff called - Role:', selectedRole, 'Year:', selectedYear);

            if (!selectedRole || selectedRole === '') {
                // If no role, this shouldn't happen due to progressive display
                return;
            }

            if (!selectedYear || selectedYear === '') {
                // Year was cleared - hide staff dropdown and stay on role-only view
                staffFilter.style.display = 'none';
                staffFilter.innerHTML = '<option value="">Select Staff Member...</option>';
                
                // Re-apply role-only filter
                applyRoleOnlyFilter(selectedRole);
                return;
            }

            // Both role and year are selected
            console.log('Both role and year selected - showing staff filter and applying role+year filter');
            
            // Show staff dropdown
            staffFilter.style.display = 'inline-block';
            
            // Clear and populate staff dropdown
            staffFilter.innerHTML = '<option value="">Select Staff Member...</option>';
            
            // Apply role+year filter (show assigned subdomains)
            applyRoleAndYearFilter(selectedRole, selectedYear);
            
            // Populate staff list for this role+year combination
            requestStaffList(selectedRole, selectedYear);
        }

        function applyRoleAndYearFilter(role, year) {
            console.log('Applying role+year filter for:', role, 'year:', year);
            
            // Build URL to show assigned subdomains for this role/year combination
            const newUrl = generateFilteredURL({ 
                filterRole: role,
                filterYear: year,
                view: 'assigned'  // Show only assigned areas for this role/year
            });
            
            window.location.href = newUrl;
        }

        function handleRoleSelection() {
            const roleFilter = document.getElementById('roleFilter');
            const yearFilter = document.getElementById('yearFilter');
            const staffFilter = document.getElementById('staffFilter');

            if (!roleFilter || !yearFilter || !staffFilter) return;

            const selectedRole = roleFilter.value;

            if (!selectedRole || selectedRole === '') {
                // No role selected - hide year and staff dropdowns
                yearFilter.style.display = 'none';
                staffFilter.style.display = 'none';
                
                // Clear their values
                yearFilter.value = '';
                staffFilter.value = '';
                
                // Clear staff dropdown options
                staffFilter.innerHTML = '<option value="">Select Staff Member...</option>';
                
                console.log('No role selected - hiding other filters');
                return;
            }

            // Role is selected - show year dropdown and apply role filter
            yearFilter.style.display = 'inline-block';
            
            // Reset year and staff selections
            yearFilter.value = '';
            staffFilter.value = '';
            staffFilter.style.display = 'none';
            staffFilter.innerHTML = '<option value="">Select Staff Member...</option>';

            console.log('Role selected:', selectedRole, '- showing year filter');

            // Apply role-only filter (show full rubric for this role)
            applyRoleOnlyFilter(selectedRole);
        }

        function applyRoleOnlyFilter(role) {
            console.log('Applying role-only filter for:', role);
            
            // Build URL to show full rubric for this role
            const newUrl = generateFilteredURL({ 
                filterRole: role,
                view: 'full'  // Show full rubric, not assigned areas
            });
            
            window.location.href = newUrl;
        }

        const DEFAULT_ERROR_MESSAGE = 'Server error. Please try again.';
        function formatClientErrorMessage(error, defaultMessage = DEFAULT_ERROR_MESSAGE) {
            let errorDetail = '';
            if (error) {
                if (error.message && typeof error.message === 'string' && error.message.trim()) {
                    errorDetail = `: ${error.message.substring(0, 75)}`;
                } else if (typeof error === 'string' && error.trim()) {
                    errorDetail = `: ${error.substring(0, 75)}`;
                }
            }
            if (!errorDetail) {
                errorDetail = `: ${defaultMessage}`;
            }
            return errorDetail;
        }

        function requestStaffList(role, year) {
            const staffFilter = document.getElementById('staffFilter');
            if (!staffFilter) {
                console.error('Staff filter dropdown element not found in requestStaffList.');
                return;
            }

            // Validate inputs
            if (!role || !year) {
                console.warn('Invalid role or year provided to requestStaffList:', { role: role, year: year });
                staffFilter.innerHTML = '<option value="">Invalid selection</option>';
                return;
            }

            // Indicate loading
            staffFilter.innerHTML = ''; // Clear existing options first
            const loadingOpt = new Option('Loading staff...', '');
            loadingOpt.disabled = true;
            loadingOpt.style.fontStyle = 'italic';
            loadingOpt.style.color = '#007bff'; // Blue color for loading
            staffFilter.appendChild(loadingOpt);
            staffFilter.disabled = true;

            console.log('Requesting staff list for role:', role, 'year:', year);

            google.script.run
                .withSuccessHandler(function(staffListData) {
                    populateStaffDropdown(staffListData);
                    if (staffFilter) staffFilter.disabled = false;
                })
                .withFailureHandler(function(error) {
                    console.error('Error fetching staff list:', error);
                    if (staffFilter) {
                        staffFilter.innerHTML = ''; // Clear existing options first
                        const errorMessage = 'Error loading staff' + formatClientErrorMessage(error);
                        const errorOpt = new Option(errorMessage, '');
                        errorOpt.disabled = true;
                        errorOpt.style.fontStyle = 'italic';
                        errorOpt.style.color = '#dc3545'; // Red color for error
                        staffFilter.appendChild(errorOpt);
                        staffFilter.disabled = false;
                    }
                })
                .getStaffListForDropdown(role, year);
        }

        function populateStaffDropdown(staffListData) {
            const staffFilter = document.getElementById('staffFilter');
            if (!staffFilter) {
                console.error('Staff filter dropdown element not found in populateStaffDropdown.');
                return;
            }

            staffFilter.innerHTML = ''; // Clear existing options first
            staffFilter.appendChild(new Option('Select Staff Member...', ''));

            if (staffListData && Array.isArray(staffListData)) {
                if (staffListData.length === 0) {
                    const noStaffOption = new Option('No staff found for this selection', '');
                    noStaffOption.disabled = true;
                    noStaffOption.style.fontStyle = 'italic';
                    noStaffOption.style.color = '#666';
                    staffFilter.appendChild(noStaffOption);
                } else {
                    staffListData.forEach(function(staff) {
                        if (typeof staff === 'object' && staff !== null &&
                            typeof staff.name === 'string' && staff.name.trim() !== '' &&
                            typeof staff.email === 'string' && staff.email.trim() !== '') {
                            
                            const option = document.createElement('option');
                            option.value = staff.email;
                            
                            // Use displayText if available, otherwise construct it
                            if (staff.displayText) {
                                option.textContent = staff.displayText;
                            } else {
                                option.textContent = `${staff.name} (${staff.role || 'Unknown'}, Year ${formatYearDisplay(staff.year)})`;
                            }
                            
                            staffFilter.appendChild(option);
                        } else {
                            console.warn('Invalid or incomplete staff item found in list. Skipping:', staff);
                        }
                    });
                }
                console.log('Staff dropdown populated with', staffListData.length, 'staff members.');
            } else {
                console.error('Failed to populate staff dropdown due to invalid or missing staffListData:', staffListData);
                const errorOption = new Option('Error loading staff data', '');
                errorOption.disabled = true;
                errorOption.style.fontStyle = 'italic';
                errorOption.style.color = '#dc3545'; // Red color for error
                staffFilter.appendChild(errorOption);
            }
        }

        function applyStaffFilter() {
            const staffFilter = document.getElementById('staffFilter');
            if (!staffFilter) return;

            const selectedStaff = staffFilter.value;
            if (!selectedStaff) return;

            console.log('Staff filter applied:', selectedStaff);

            // Redirect to view as selected staff member
            const newUrl = generateFilteredURL({ filterStaff: selectedStaff, view: 'assigned' });
            window.location.href = newUrl;
        }

        function clearAllFilters() {
            console.log('Clearing all filters');

            // Build URL without filter parameters
            const newUrl = generateFilteredURL({});
            window.location.href = newUrl;
        }

        // Enhanced cache busting and page management

        // Prevent browser caching of this page
        if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_BACK_FORWARD) {
            console.log('Detected back/forward navigation - forcing reload');
            window.location.reload(true);
        }

        // Store page load info for debugging
        window.pageLoadInfo = {
            timestamp: Date.now(),
            userAgent: navigator.userAgent,
            role: <?= JSON.stringify(data.userContext ? data.userContext.role : "unknown").replace(/</g, '\\u003c') ?>,
            cacheVersion: <?= JSON.stringify(data.userContext ? data.userContext.cacheVersion : "unknown").replace(/</g, '\\u003c') ?>,
            requestId: <?= JSON.stringify(data.userContext ? data.userContext.requestId : "unknown").replace(/</g, '\\u003c') ?>,
            isMyOwnRubricView: <?= data.userContext?.isMyOwnRubricView ? 'true' : 'false' ?>
        };

        function initializeFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);

            // Restore Administrator filter
            const probationaryFilter = document.getElementById('probationaryFilter');
            if (probationaryFilter && urlParams.get('filterType')) {
                probationaryFilter.value = urlParams.get('filterType');
            }

            // Restore role/year filters
            const roleFilter = document.getElementById('roleFilter');
            const yearFilter = document.getElementById('yearFilter');

            if (roleFilter && urlParams.get('filterRole')) {
                roleFilter.value = urlParams.get('filterRole');
            }

            if (yearFilter && urlParams.get('filterYear')) {
                yearFilter.value = urlParams.get('filterYear');
            }

            // Update staff list if both role and year are set
            if (roleFilter && yearFilter && roleFilter.value && yearFilter.value) {
                updateAvailableStaff();
            }
        }

        // --- URL Generation Utilities ---
        function generateFilteredURL(params) {
            const url = new URL(window.location);

            // Clear existing filter parameters
            url.searchParams.delete('filterType');
            url.searchParams.delete('filterRole');
            url.searchParams.delete('filterYear');
            url.searchParams.delete('filterStaff');
            url.searchParams.delete('view');

            // Add new parameters
            if (params.filterType) url.searchParams.set('filterType', params.filterType);
            if (params.filterRole) url.searchParams.set('filterRole', params.filterRole);
            if (params.filterYear) url.searchParams.set('filterYear', params.filterYear);
            if (params.filterStaff) url.searchParams.set('filterStaff', params.filterStaff);
            if (params.view) url.searchParams.set('view', params.view);

            // Always add cache busting
            url.searchParams.set('t', Date.now());

            return url.toString();
        }

        // --- Client-Side View Mode Toggling ---
        // The following functions manage the view mode (full/assigned) dynamically on the client-side
        // without a page reload. The preference is saved in sessionStorage for the current session.
        // View Mode Toggle Functions
        let currentViewMode = <?= JSON.stringify(data.userContext?.viewMode || "full").replace(/</g, '\\u003c') ?>;
        const userAssignedSubdomains = <?= data.userContext?.assignedSubdomains ? JSON.stringify(data.userContext.assignedSubdomains).replace(/</g, '\\u003c') : 'null' ?>;

        function toggleViewMode() {
            console.log('toggleViewMode called. Current mode:', currentViewMode);
            
            if (currentViewMode === 'full') {
                console.log('Toggling from full to assigned view');
                switchToAssignedView();
            } else {
                console.log('Toggling from assigned to full view');
                switchToFullView();
            }
            
            // Provide user feedback
            const newMode = currentViewMode === 'full' ? 'Full Rubric' : 'Assigned Areas';
            showToast(`Switched to ${newMode} view`);
        }

        function switchToAssignedView() {
            currentViewMode = 'assigned';
            updateViewToggleButton();
            hideUnassignedComponents();
            saveViewModePreference();

            console.log('Switched to assigned view mode');
        }

        function switchToFullView() {
            currentViewMode = 'full';
            console.log('switchToFullView: currentViewMode set to:', currentViewMode);
            updateViewToggleButton();
            showAllComponents();
            saveViewModePreference();

            console.log('Switched to full view mode');
            
            // Extra verification that all components are visible
            const hiddenComponents = document.querySelectorAll('.component-section.component-hidden');
            if (hiddenComponents.length > 0) {
                console.warn(`WARNING: ${hiddenComponents.length} components still hidden after switching to full view!`);
                
                // Force show all components by explicitly removing hidden class
                hiddenComponents.forEach(component => {
                    console.log('Force showing component:', component);
                    component.classList.remove('component-hidden');
                });
            }
        }

        function updateViewToggleButton() {
            const button = document.getElementById('viewToggleBtn');
            const text = document.getElementById('viewToggleText');

            if (!button || !text) return;

            if (currentViewMode === 'assigned') {
                text.innerHTML = '📚 View: Full Rubric';
                button.classList.add('assigned-mode');
                button.title = 'Click to view the complete rubric';
            } else {
                text.innerHTML = '📋 View: My Assigned Areas';
                button.classList.remove('assigned-mode');
                button.title = 'Click to view only your assigned areas';
            }
        }

        function hideUnassignedComponents() {
            if (!userAssignedSubdomains) return;

            const components = document.querySelectorAll('.component-section');
            components.forEach(function(component) {
                const isAssigned = component.getAttribute('data-assigned') === 'true';
                updateComponentVisualState(component, isAssigned, 'assigned');
            });

            // Hide assignment indicators in assigned mode
            // This part remains as it's specific to the view mode switch, not general component state
            const indicators = document.querySelectorAll('.assignment-indicator');
            indicators.forEach(function(indicator) {
                indicator.classList.add('indicator-hidden');
            });

            // The hiddenCount variable is no longer available with the new function,
            // so the specific count cannot be logged here. We can log a generic message.
            console.log('Hid unassigned components using new visual state function.');
            updateDomainVisibility();
        }

        function showAllComponents() {
            console.log('showAllComponents called');
            const components = document.querySelectorAll('.component-section');
            console.log(`Found ${components.length} components to process`);
            
            let hiddenCount = 0;
            components.forEach(function(component) {
                // Count hidden components for logging
                if (component.classList.contains('component-hidden')) {
                    hiddenCount++;
                }
                
                const isAssigned = component.getAttribute('data-assigned') === 'true';
                updateComponentVisualState(component, isAssigned, 'full');
            });

            // Show assignment indicators in full mode
            const indicators = document.querySelectorAll('.assignment-indicator');
            indicators.forEach(function(indicator) {
                indicator.classList.remove('indicator-hidden');
            });

            console.log(`Showed all ${components.length} components (previously ${hiddenCount} were hidden)`);
            updateDomainVisibility();
            
            // Final verification
            const stillHidden = document.querySelectorAll('.component-section.component-hidden');
            if (stillHidden.length > 0) {
                console.error(`ERROR: ${stillHidden.length} components are still hidden after showAllComponents!`);
            }
        }

        function updateDomainVisibility() {
            // Hide domains that have no visible components
            const domains = document.querySelectorAll('.domain-section');

            domains.forEach(function(domain) {
                const visibleComponents = domain.querySelectorAll('.component-section:not(.component-hidden)');
                const domainHeader = domain.querySelector('.domain-header');
                const navButton = document.querySelector('[data-domain="' + domain.id.split('-')[1] + '"]');

                if (visibleComponents.length === 0) {
                    domain.style.display = 'none';
                    if (navButton) navButton.style.display = 'none';
                } else {
                    domain.style.display = 'block';
                    if (navButton) navButton.style.display = 'block';
                }
            });
        }

        function saveViewModePreference() {
            try {
                const storageKey = 'viewMode_' + (window.pageLoadInfo?.cacheVersion || 'default');
                sessionStorage.setItem(storageKey, currentViewMode);
                console.log('View mode preference saved:', currentViewMode);
            } catch (e) {
                console.log('Could not save view mode preference:', e);
            }
        }

        // Component Assignment Visual Functions
        function updateComponentVisualState(componentElement, isAssigned, currentViewMode) {
            // Clear existing classes
            componentElement.classList.remove('component-assigned', 'component-not-assigned', 'component-hidden');

            // Visibility Logic
            if (currentViewMode === 'assigned') {
                if (!isAssigned) {
                    componentElement.classList.add('component-hidden');
                }
            } else if (currentViewMode === 'full') {
                // Explicitly ensure component is visible in full mode
                componentElement.classList.remove('component-hidden');
            }

            // Styling Logic (only if not hidden by the above)
            if (!componentElement.classList.contains('component-hidden')) {
                // Only apply assignment styling in 'assigned' mode, not in 'full' mode
                if (currentViewMode === 'assigned') {
                    if (isAssigned) {
                        componentElement.classList.add('component-assigned');
                        addAssignmentTooltip(componentElement, 'This component is assigned to you for evaluation');
                    } else {
                        componentElement.classList.add('component-not-assigned');
                        addAssignmentTooltip(componentElement, 'This component is not assigned to you this year');
                    }
                } else if (currentViewMode === 'full') {
                    // In full mode, remove any assignment tooltips and show all components neutrally
                    removeAssignmentTooltip(componentElement);
                }
            }
        }

        function highlightAssignedComponents() {
            if (!userAssignedSubdomains) return;

            const components = document.querySelectorAll('.component-section');
            components.forEach(function(component) {
                const isAssigned = component.getAttribute('data-assigned') === 'true';
                // Assuming 'full' mode for highlighting purposes, as this function is about visual styling, not hiding.
                updateComponentVisualState(component, isAssigned, 'full');
            });

            console.log('Component assignment highlighting applied using new visual state function.');
        }

        function addAssignmentTooltip(element, message) {
            element.title = message;
        }

        function removeAssignmentTooltip(element) {
            element.removeAttribute('title');
        }

        function createAssignmentSummary() {
            if (!userAssignedSubdomains) return;

            const summary = {
                domain1: userAssignedSubdomains.domain1?.length || 0,
                domain2: userAssignedSubdomains.domain2?.length || 0,
                domain3: userAssignedSubdomains.domain3?.length || 0,
                domain4: userAssignedSubdomains.domain4?.length || 0
            };

            summary.total = summary.domain1 + summary.domain2 + summary.domain3 + summary.domain4;

            console.log('Assignment summary:', summary);
            return summary;
        }

        function addAssignmentCounters() {
            if (!userAssignedSubdomains) return;

            const domains = document.querySelectorAll('.domain-section');

            domains.forEach(function(domain, index) {
                const domainKey = 'domain' + (index + 1);
                const assignedCount = userAssignedSubdomains[domainKey]?.length || 0;
                const totalComponents = domain.querySelectorAll('.component-section').length;

                const header = domain.querySelector('.domain-header');
                if (header && assignedCount > 0) {
                    const counter = document.createElement('span');
                    counter.className = 'assignment-counter'; // Keep this for potential general selections
                    counter.classList.add('assignment-counter-styles'); // Add new class for specific styling
                    counter.textContent = ' (' + assignedCount + '/' + totalComponents + ' assigned)';
                    // counter.style.cssText = 'font-size: 0.9rem; opacity: 0.8; margin-left: 10px;'; // This line is removed
                    header.appendChild(counter);
                }
            });
        }


        // Restore evidence section state on page load
        function restoreEvidenceState() {
            try {
                const storageKey = 'evidenceState_' + (window.pageLoadInfo?.cacheVersion || 'default');
                const allStates = JSON.parse(sessionStorage.getItem(storageKey) || '{}');

                for (const componentId in allStates) {
                    if (allStates[componentId] === true) {
                        const contentId = 'evidence-' + componentId;
                        const content = document.getElementById(contentId);
                        if (content) {
                            content.classList.add('expanded');
                            // For dynamic content, use global Quill management if available
                            setTimeout(() => {
                                if (window.globalQuillInstances && !window.globalQuillInstances[componentId] && window.initializeQuillEditor) {
                                    window.initializeQuillEditor(componentId);
                                }
                            }, 100);
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not restore evidence section state:', e);
            }
        }

        
        function scrollToDomain(domainIdx) {
            const element = document.getElementById('domain-' + domainIdx);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Enhanced page refresh with cache busting
        function forcePageRefresh() {
            console.log('Forcing page refresh with cache busting');

            const url = new URL(window.location);
            url.searchParams.set('refresh', 'true');
            url.searchParams.set('nocache', 'true');
            url.searchParams.set('t', Date.now());
            url.searchParams.set('r', Math.random().toString(36).substr(2, 9));

            window.location.href = url.toString();
        }

        function loadFinalizedObservations() {
            google.script.run
                .withSuccessHandler(function(observations) {
                    const container = document.getElementById('finalizedObservations');
                    if (!container) return;

                    if (observations && observations.length > 0) {
                        container.innerHTML = ''; // Clear the loading message
                        observations.forEach(function(obs) {
                            const card = document.createElement('div');
                            card.className = 'observation-card';
                            card.setAttribute('data-observation-id', obs.observationId);
                            card.onclick = function() {
                                viewObservation(obs.observationId);
                            };

                            const date = new Date(obs.createdAt).toLocaleDateString();
                            card.innerHTML = `
                                <h3>Observation from ${date}</h3>
                                <p>Status: ${obs.status}</p>
                            `;
                            container.appendChild(card);
                        });
                    } else {
                        container.innerHTML = '<p>No finalized observations found.</p>';
                    }
                })
                .withFailureHandler(function(error) {
                    const container = document.getElementById('finalizedObservations');
                    if (container) {
                        container.innerHTML = '<p style="color: red;">Error loading observations: ' + error.message + '</p>';
                    }
                })
                .getFinalizedObservationsForUser();
        }

        function viewObservation(observationId) {
            console.log('Requesting to view observation:', observationId);
            showLoadingSpinner();

            google.script.run
                .withSuccessHandler(function(response) {
                    hideLoadingSpinner();
                    if (response.success) {
                        const observationData = response.observation;
                        populateRubric(observationData);
                        showRubricView('full');
                        document.getElementById('rubricView').classList.add('read-only');

                        const header = document.querySelector('#rubricView .header');
                        if (header && !header.querySelector('.back-btn')) {
                            const backButton = document.createElement('button');
                            backButton.textContent = '← Back to Landing Page';
                            backButton.className = 'landing-btn back-btn';
                            backButton.onclick = backToLandingPage;
                            header.prepend(backButton);
                        }
                    } else {
                        alert('Error loading observation: ' + response.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoadingSpinner();
                    alert('Error loading observation: ' + error.message);
                })
                .loadFinalizedObservationForViewing(observationId);
        }

        function populateRubric(observation) {
            if (!observation || !observation.observationData) return;

            // Reset any previous selections
            document.querySelectorAll('.rating-cell.selected').forEach(cell => cell.classList.remove('selected'));
            document.querySelectorAll('.look-for-item input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);

            const observationData = observation.observationData;

            for (const componentId in observationData) {
                const componentData = observationData[componentId];

                if(componentData.proficiency) {
                    const cell = document.querySelector(`.rating-cell[data-component-id="${componentId}"][data-rating="${componentData.proficiency}"]`);
                    if (cell) {
                        cell.classList.add('selected');
                    }
                }

                if (componentData.lookfors && componentData.lookfors.length > 0) {
                    const lookForsSet = new Set(componentData.lookfors);
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                    for (const checkbox of checkboxes) {
                        const labelText = checkbox.nextElementSibling?.textContent;
                        if (labelText && lookForsSet.has(labelText)) {
                            checkbox.checked = true;
                        }
                    }
                }

                const evidenceSection = document.getElementById(`evidence-${componentId}`);
                const notesContainer = evidenceSection?.querySelector('.notes-display');
                if (notesContainer && componentData.notes) {
                    notesContainer.innerHTML = componentData.notes;
                    if(evidenceSection) evidenceSection.style.display = 'block';
                } else {
                    if(evidenceSection) evidenceSection.style.display = 'none';
                }

                const evidenceLinks = observation.evidenceLinks && observation.evidenceLinks[componentId];
                const evidenceContainer = evidenceSection?.querySelector('.media-links-container');

                if (evidenceContainer && evidenceLinks && evidenceLinks.length > 0) {
                    evidenceContainer.innerHTML = '<h4>Evidence Files:</h4>';
                    const list = document.createElement('ul');
                    evidenceLinks.forEach(link => {
                        const item = document.createElement('li');
                        item.className = 'media-link-item';
                        item.innerHTML = `<a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.name}</a>`;
                        list.appendChild(item);
                    });
                    evidenceContainer.appendChild(list);
                    if(evidenceSection) evidenceSection.style.display = 'block';
                } else if (evidenceContainer) {
                    evidenceContainer.innerHTML = '';
                }
            }
        }

        function showLoadingSpinner() { console.log('Showing spinner...'); }
        function hideLoadingSpinner() { console.log('Hiding spinner...'); }

        function backToLandingPage() {
            // For My Own Rubric view, reload the entire web app to return to landing page
            if (window.pageLoadInfo && window.pageLoadInfo.isMyOwnRubricView) {
                // Reload the web app entirely (removes any parameters and restarts fresh)
                window.location.reload(true);
            } else {
                // Legacy behavior for other contexts
                if (typeof showLandingPage === 'function') {
                    showLandingPage();
                }
                document.getElementById('rubricView').classList.remove('read-only');
                const backButton = document.querySelector('#rubricView .header .back-btn');
                if (backButton) {
                    backButton.remove();
                }
            }
        }

        // showRubricView function removed - using direct toggle approach instead

        function clearObservationState() {
            // Clear any selected proficiency rating cells
            document.querySelectorAll('.rating-cell.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // Clear any checked look-for checkboxes 
            document.querySelectorAll('.look-for-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Hide all evidence sections and clear their content
            document.querySelectorAll('[id^="evidence-"]').forEach(evidenceSection => {
                evidenceSection.style.display = 'none';
                const notesDisplay = evidenceSection.querySelector('.notes-display');
                if (notesDisplay) {
                    notesDisplay.innerHTML = '';
                }
                const mediaContainer = evidenceSection.querySelector('.media-links-container');
                if (mediaContainer) {
                    mediaContainer.innerHTML = '';
                }
            });
            
            // Remove read-only class if present
            document.getElementById('rubricView').classList.remove('read-only');
        }

        // showLandingPage function removed - no longer using landing page

        // === Observations Modal Functions ===
        
        function checkForObservations() {
            // Check if user has finalized observations and show/hide button accordingly
            google.script.run
                .withSuccessHandler(function(response) {
                    const button = document.getElementById('myObservationsBtn');
                    if (response.success && response.observations && response.observations.length > 0) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                })
                .withFailureHandler(function(error) {
                    console.warn('Could not check for observations:', error);
                })
                .getFinalizedObservationsForStaff();
        }

        function openObservationsModal() {
            const modal = document.getElementById('observationsModal');
            const loading = document.getElementById('observationsLoading');
            const content = document.getElementById('observationsContent');
            const empty = document.getElementById('observationsEmpty');
            
            // Show modal and loading state
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';
            
            // Load observations
            google.script.run
                .withSuccessHandler(function(response) {
                    loading.style.display = 'none';
                    
                    if (response.success && response.observations && response.observations.length > 0) {
                        populateObservations(response.observations);
                        content.style.display = 'block';
                    } else {
                        empty.style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    loading.style.display = 'none';
                    content.innerHTML = '<div class="error-message">Failed to load observations. Please try again.</div>';
                    content.style.display = 'block';
                    console.error('Error loading observations:', error);
                })
                .getFinalizedObservationsForStaff();
        }

        function closeObservationsModal() {
            document.getElementById('observationsModal').style.display = 'none';
        }

        function populateObservations(observations) {
            const container = document.getElementById('observationsContent');
            container.innerHTML = '';
            
            observations.forEach(obs => {
                const card = createObservationCard(obs);
                container.appendChild(card);
            });
        }

        function createObservationCard(observation) {
            const card = document.createElement('div');
            card.className = 'observation-card';
            
            const date = new Date(observation.createdAt).toLocaleDateString();
            
            card.innerHTML = `
                <h3>${escapeHtml(observation.observationName || 'Observation')}</h3>
                <div class="observation-meta">
                    Created: ${date}
                    ${observation.pdfUrl ? ' • PDF Available' : ''}
                    ${observation.folderUrl ? ' • 📁 Click to open folder' : ''}
                </div>
                <div class="file-grid">
                    ${observation.files.map(file => createFileCard(file)).join('')}
                </div>
            `;
            
            // Add click handler to open Google Drive folder
            if (observation.folderUrl) {
                card.addEventListener('click', function() {
                    window.open(observation.folderUrl, '_blank');
                    showToast('Opening observation folder...');
                });
                
                // Add visual feedback for clickable state
                card.style.cursor = 'pointer';
                card.setAttribute('title', 'Click to open Google Drive folder with all observation materials');
            } else {
                // No folder URL available - make it clear it's not clickable
                card.style.cursor = 'default';
                card.setAttribute('title', 'Observation folder not available');
            }
            
            return card;
        }

        function createFileCard(file) {
            const icon = getFileIcon(file.type);
            const size = formatFileSize(file.size);
            
            return `
                <a href="${file.url}" target="_blank" class="file-card" title="Open ${escapeHtml(file.name)}">
                    <span class="file-icon">${icon}</span>
                    <div class="file-name">${escapeHtml(file.name)}</div>
                    <div class="file-size">${size}</div>
                </a>
            `;
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return '📄';
            if (mimeType.includes('image')) return '🖼️';
            if (mimeType.includes('video')) return '🎥';
            if (mimeType.includes('audio')) return '🎵';
            if (mimeType.includes('document') || mimeType.includes('word')) return '📝';
            return '📎';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('observationsModal');
            if (e.target === modal) {
                closeObservationsModal();
            }
        });

        // === View Mode Toggle Functions (from peer evaluator pattern) ===
        // Note: currentViewMode is already declared by server template injection

        function setViewMode(mode) {
            currentViewMode = mode;
            updateViewToggle();
            updateComponentVisibility();
            
            // Save preference to sessionStorage
            try {
                const storageKey = 'viewMode_' + (window.pageLoadInfo?.cacheVersion || 'default');
                sessionStorage.setItem(storageKey, mode);
            } catch (e) {
                console.warn('Could not save view mode preference:', e);
            }
            
            console.log('View mode set to:', mode);
        }

        function updateViewToggle() {
            const assignedToggle = document.getElementById('assignedToggle');
            const fullToggle = document.getElementById('fullToggle');
            const slider = document.getElementById('toggleSlider');
            
            if (!assignedToggle || !fullToggle || !slider) return;
            
            // Update active states
            assignedToggle.classList.toggle('active', currentViewMode === 'assigned');
            fullToggle.classList.toggle('active', currentViewMode === 'full');
            
            // Animate slider position
            const toggleWidth = assignedToggle.offsetWidth;
            if (currentViewMode === 'assigned') {
                slider.style.width = toggleWidth + 'px';
                slider.style.transform = 'translateX(0)';
            } else {
                slider.style.width = fullToggle.offsetWidth + 'px';
                slider.style.transform = `translateX(${toggleWidth}px)`;
            }
        }

        function updateComponentVisibility() {
            const components = document.querySelectorAll('.component-section');
            if (currentViewMode === 'assigned') {
                components.forEach(comp => {
                    // Hide components that are not assigned using CSS class
                    if (comp.dataset.assigned !== 'true') {
                        comp.classList.add('component-hidden');
                    } else {
                        comp.classList.remove('component-hidden');
                    }
                });
            } else {
                // Show all components in full mode by removing hidden class
                components.forEach(comp => {
                    comp.classList.remove('component-hidden');
                });
            }
            
            console.log(`Updated component visibility for ${currentViewMode} mode`);
        }

        // Enhanced DOMContentLoaded handler
        document.addEventListener('DOMContentLoaded', function() {
            // Start directly in rubric view - no landing page
            console.log('Page loaded:', window.pageLoadInfo);

            // Make rubric read-only for reference viewing
            document.getElementById('rubricView').classList.add('read-only');

            // Load view mode preference from sessionStorage (only for special access users)
            // Regular staff should respect the server-provided viewMode
            <? if (data.userContext && data.userContext.hasSpecialAccess) { ?>
            try {
                const storageKey = 'viewMode_' + (window.pageLoadInfo?.cacheVersion || 'default');
                const savedMode = sessionStorage.getItem(storageKey);
                if (savedMode === 'assigned' || savedMode === 'full') {
                    currentViewMode = savedMode;
                    console.log('View mode restored from sessionStorage for special access user:', currentViewMode);
                }
            } catch (e) {
                console.warn('Could not access sessionStorage for view mode preference:', e);
            }
            <? } else { ?>
            console.log('Regular staff user - using server-provided viewMode:', currentViewMode);
            <? } ?>

            // Initialize toggle UI and component visibility
            updateViewToggle();
            updateComponentVisibility();
            restoreLookForsState(); // Restore the state of look-fors sections
            
            // Check for observations and show button if applicable
            checkForObservations();

            // Initialize view mode functionality
            if (userAssignedSubdomains) {
                // Add visual enhancements for assignments (these are always useful)
                highlightAssignedComponents();
                addAssignmentCounters();
                if (currentViewMode === 'assigned') {
                    hideUnassignedComponents();
                } else {
                    showAllComponents();
                }

                updateViewToggleButton();

                console.log('View mode initialized:', currentViewMode);
                console.log('Assignment summary:', createAssignmentSummary());
            }

            // Initialize special role filters
            initializeFiltersFromURL();

            // Handle navigation button clicks
            const navigation = document.querySelector('.navigation');
            if (navigation) {
                navigation.addEventListener('click', function(e) {
                    if (e.target.classList.contains('nav-button')) {
                        const domainIdx = e.target.getAttribute('data-domain');
                        if (domainIdx !== null) {
                            scrollToDomain(parseInt(domainIdx));
                        }
                    }
                });
            }

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+R or Cmd+R for force refresh
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    forcePageRefresh();
                }

                // F5 for force refresh
                if (e.key === 'F5') {
                    e.preventDefault();
                    forcePageRefresh();
                }

                // V key to toggle view mode
                if (e.key === 'v' || e.key === 'V') {
                    if (userAssignedSubdomains && !e.ctrlKey && !e.metaKey && !e.altKey) {
                        e.preventDefault();
                        toggleViewMode();
                    }
                }
            });

            // Read-only mode - rating cells display selections but are not clickable
        });
        
        // Show/hide back to top button
        window.addEventListener('scroll', function() {
            const backToTop = document.getElementById('backToTop');
            if (backToTop) {
                if (window.scrollY > 300) {
                    backToTop.classList.add('visible');
                } else {
                    backToTop.classList.remove('visible');
                }
            }
            
            // Update floating navigation visibility
            updateFloatingNav();
        });
        
        // Highlight active navigation button
        window.addEventListener('scroll', function() {
            const navButtons = document.querySelectorAll('.nav-button');
            const domainSections = document.querySelectorAll('.domain-section');
            
            let currentDomain = -1;
            for (let i = 0; i < domainSections.length; i++) {
                const rect = domainSections[i].getBoundingClientRect();
                if (rect.top <= 100 && rect.bottom > 0) {
                    currentDomain = i;
                }
            }
            
            navButtons.forEach(function(button, index) {
                if (index === currentDomain) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        });
        
        // Enhanced auto-refresh with cache version checking
        const autoRefreshInterval = <?= data.userContext && data.userContext.debugMode ? 300000 : 600000 ?>; // 5 min debug, 10 min normal

        setTimeout(function() {
            console.log('Auto-refresh triggered');

            // In debug mode, show notification
            <? if (data.userContext && data.userContext.debugMode) { ?>
            const notice = document.createElement('div');
            notice.style.cssText = 'position:fixed; top:50px; right:10px; background:#007bff; color:white; padding:10px; border-radius:6px; z-index:9998; font-size:0.9rem;';
            notice.textContent = '🔄 Auto-refreshing to get latest data...';
            document.body.appendChild(notice);

            setTimeout(function() {
                forcePageRefresh();
            }, 2000);
            <? } else { ?>
            forcePageRefresh();
            <? } ?>

        }, autoRefreshInterval);

        // Performance monitoring
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (window.performance && window.performance.timing) {
                    const timing = window.performance.timing;
                    const loadTime = timing.loadEventEnd - timing.navigationStart;
                    console.log('Page load time:', loadTime + 'ms');

                    // Report slow loads
                    if (loadTime > 5000) {
                        console.warn('Slow page load detected. Consider force refresh.');
                    }
                }
            }, 0);
        });

        // Expose utility functions globally for debugging
        window.debugUtils = {
            forceRefresh: forcePageRefresh,
            pageInfo: window.pageLoadInfo,
            clearState: function() {
                try {
                    sessionStorage.clear();
                    console.log('Session state cleared');
                } catch (e) {
                    console.log('Error clearing session state:', e);
                }
            }
        };

        console.log('Enhanced Danielson Framework app loaded successfully');
        <? if (data.userContext && data.userContext.debugMode) { ?>
        console.log('🐛 DEBUG MODE ACTIVE - Check debug info panel in top-right corner');
        console.log('Available debug commands: window.debugUtils.forceRefresh(), window.debugUtils.clearState()');
        <? } ?>

        // Floating Navigation Widget Functions
        let floatingNavOpen = false;

        function toggleFloatingNav() {
            const menu = document.getElementById('floatingNavMenu');
            if (menu) {
                floatingNavOpen = !floatingNavOpen;
                if (floatingNavOpen) {
                    menu.classList.add('open');
                } else {
                    menu.classList.remove('open');
                }
            }
        }

        function closeFloatingNav() {
            const menu = document.getElementById('floatingNavMenu');
            if (menu) {
                menu.classList.remove('open');
                floatingNavOpen = false;
            }
        }

        // Show/hide floating navigation based on scroll position
        function updateFloatingNav() {
            const floatingNav = document.getElementById('floatingNav');
            const navigation = document.querySelector('.navigation');
            
            if (floatingNav && navigation) {
                const navigationRect = navigation.getBoundingClientRect();
                const isNavigationVisible = navigationRect.bottom > 0;
                
                if (isNavigationVisible) {
                    floatingNav.classList.remove('visible');
                    closeFloatingNav();
                } else {
                    floatingNav.classList.add('visible');
                }
            }
        }

        // Close floating nav when clicking outside
        document.addEventListener('click', function(e) {
            const floatingNav = document.getElementById('floatingNav');
            if (floatingNav && !floatingNav.contains(e.target)) {
                closeFloatingNav();
            }
        });

        // Close floating nav when pressing Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFloatingNav();
            }
        });

        // --- URL-Based View Mode Switching ---
        // These functions change the view mode by generating a new URL with the 'view' parameter
        // and then reloading the page. This is useful for creating bookmarkable/shareable links
        // or for programmatically setting the view state when a page reload is acceptable or desired.
        // Note: As of the last review, these specific two functions are not directly called by other
        // parts of this script but serve as utilities if such URL-based view switching is needed.
        // The `generateFilteredURL` function IS used by other filter applications (e.g., staff filter).
        function switchToAssignedViewWithURL() {
            const url = generateFilteredURL({ view: 'assigned' });
            window.location.href = url;
        }

        function switchToFullViewWithURL() {
            const url = generateFilteredURL({ view: 'full' });
            window.location.href = url;
        }

        // Debug functions for troubleshooting
        window.debugViewMode = {
            getCurrentMode: function() { return currentViewMode; },
            getAssignedSubdomains: function() { return userAssignedSubdomains; },
            toggleMode: toggleViewMode,
            showAll: showAllComponents,
            hideUnassigned: hideUnassignedComponents,
            getAssignmentSummary: createAssignmentSummary
        };

        console.log('Enhanced Danielson Framework app loaded with view mode support');
        <? if (data.userContext && data.userContext.debugMode) { ?>
        console.log('🐛 DEBUG MODE ACTIVE');
        console.log('View mode debug commands available: window.debugViewMode');
        console.log('Current view mode:', currentViewMode);
        console.log('User assigned subdomains:', userAssignedSubdomains);
        <? } ?>

        function showToast(message) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // Read-only display mode - no editing functionality



        // Simple read-only toggle for evidence sections
        function toggleEvidenceSection(contentId) {
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.toggle('expanded');
            }
        }


        // Toggle look-fors section visibility for staff view
        function toggleLookFors(contentId) {
            const content = document.getElementById(contentId);
            const chevronId = 'chevron-' + contentId;
            const chevron = document.getElementById(chevronId);
            
            if (!content || !chevron) {
                console.warn('toggleLookFors: Could not find elements for', contentId);
                return;
            }
            
            const isCurrentlyExpanded = content.classList.contains('expanded');
            
            if (isCurrentlyExpanded) {
                // Collapse
                content.classList.remove('expanded');
                chevron.textContent = '▶';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // Expand
                content.classList.add('expanded');
                chevron.textContent = '▼';
                chevron.style.transform = 'rotate(90deg)';
            }
            
            // Save state in sessionStorage for persistence
            try {
                const storageKey = 'lookForsState_' + (window.pageLoadInfo?.cacheVersion || 'default');
                const allStates = JSON.parse(sessionStorage.getItem(storageKey) || '{}');
                allStates[contentId] = !isCurrentlyExpanded;
                sessionStorage.setItem(storageKey, JSON.stringify(allStates));
                console.log('Look-fors state saved:', contentId, !isCurrentlyExpanded);
            } catch (e) {
                console.warn('Could not save look-fors state:', e);
            }
        }

        // Restore look-fors state for staff view format
        function restoreLookForsState() {
            try {
                const storageKey = 'lookForsState_' + (window.pageLoadInfo?.cacheVersion || 'default');
                const allStates = JSON.parse(sessionStorage.getItem(storageKey) || '{}');
                
                Object.keys(allStates).forEach(function(contentId) {
                    const isExpanded = allStates[contentId];
                    if (isExpanded) {
                        const content = document.getElementById(contentId);
                        const chevronId = 'chevron-' + contentId;
                        const chevron = document.getElementById(chevronId);
                        
                        if (content && chevron) {
                            content.classList.add('expanded');
                            chevron.textContent = '▼';
                            chevron.style.transform = 'rotate(90deg)';
                        }
                    }
                });
                
                console.log('Restored staff look-fors state for', Object.keys(allStates).length, 'sections');
            } catch (e) {
                console.warn('Could not restore staff look-fors state:', e);
            }
        }

        // === Work Product Modal Functions ===
        let saveTimeouts = {};
        let currentWorkProductObservationId = null;

        function openWorkProductModal() {
            loadWorkProductQuestions();
            document.getElementById('workProductModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeWorkProductModal() {
            document.getElementById('workProductModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        function closeWorkProductModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeWorkProductModal();
            }
        }

        function loadWorkProductQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #6b7280; font-size: 1.1rem; margin-bottom: 10px;">Loading Work Product Questions...</div>
                    <div style="color: #9ca3af; font-size: 0.9rem;">Please wait while we retrieve your questions and responses.</div>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayQuestions(result.questions);
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Error loading questions: ' + result.error + '</div>';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load questions:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load questions. Please try again.</div>';
                })
                .getWorkProductQuestionsForClient();
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsContainer');

            if (!questions || questions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No questions available.</div>';
                return;
            }

            let html = '';
            questions.forEach(question => {
                html += `
                    <div class="work-product-question">
                        <div class="work-product-question-text">${question.questionText}</div>
                        <textarea class="work-product-textarea"
                                  id="answer-${question.questionId}"
                                  placeholder="Loading your response..."
                                  disabled
                                  oninput="handleAnswerInput('${question.questionId}')"></textarea>
                        <div class="save-status" id="status-${question.questionId}" style="color: #6b7280; font-style: italic;">Loading responses...</div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Load existing answers
            loadExistingAnswers();
        }

        function loadExistingAnswers() {
            // Get observation ID from current context
            getCurrentWorkProductObservationId(function(observationId) {
                if (!observationId) {
                    // No observation ID - enable textareas and clear loading state
                    enableTextareasAndClearLoadingState();
                    return;
                }

                currentWorkProductObservationId = observationId;

                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success && result.answers) {
                            result.answers.forEach(answer => {
                                const textarea = document.getElementById('answer-' + answer.questionId);
                                if (textarea) {
                                    textarea.value = answer.answerText;
                                }
                            });
                        }
                        // Enable textareas and clear loading state
                        enableTextareasAndClearLoadingState();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Failed to load existing answers:', error);
                        // Enable textareas and clear loading state even on error
                        enableTextareasAndClearLoadingState();
                    })
                    .getWorkProductAnswersForClient(observationId);
            });
        }

        function enableTextareasAndClearLoadingState() {
            // Enable all textareas and update placeholders
            const textareas = document.querySelectorAll('.work-product-textarea');
            textareas.forEach(textarea => {
                textarea.disabled = false;
                if (textarea.placeholder === 'Loading your response...') {
                    textarea.placeholder = 'Enter your response here...';
                }
            });

            // Clear loading status messages
            const statusElements = document.querySelectorAll('.save-status');
            statusElements.forEach(status => {
                if (status.textContent === 'Loading responses...') {
                    status.textContent = '';
                    status.style.fontStyle = '';
                }
            });
        }

        function getCurrentWorkProductObservationId(callback) {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.observationId) {
                        callback(result.observationId);
                    } else {
                        callback(null);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to get observation ID:', error);
                    callback(null);
                })
                .getCurrentUserWorkProductObservationId();
        }

        function handleAnswerInput(questionId) {
            const textarea = document.getElementById('answer-' + questionId);
            const statusDiv = document.getElementById('status-' + questionId);

            if (!textarea || !currentWorkProductObservationId) return;

            // Clear existing timeout
            if (saveTimeouts[questionId]) {
                clearTimeout(saveTimeouts[questionId]);
            }

            // Show saving status
            statusDiv.textContent = 'Typing...';
            statusDiv.className = 'save-status saving';

            // Set new timeout for debounced save
            saveTimeouts[questionId] = setTimeout(() => {
                saveAnswer(questionId, textarea.value, statusDiv);
            }, 1500); // 1.5 second debounce
        }

        function saveAnswer(questionId, answerText, statusDiv) {
            statusDiv.textContent = 'Saving...';
            statusDiv.className = 'save-status saving';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        statusDiv.textContent = 'Saved';
                        statusDiv.className = 'save-status saved';
                        setTimeout(() => {
                            statusDiv.style.opacity = '0.5';
                        }, 2000);
                    } else {
                        statusDiv.textContent = 'Error saving: ' + result.error;
                        statusDiv.className = 'save-status error';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Save failed:', error);
                    statusDiv.textContent = 'Save failed. Please try again.';
                    statusDiv.className = 'save-status error';
                })
                .saveWorkProductAnswerFromClient(currentWorkProductObservationId, questionId, answerText);
        }

    </script>

    <!-- Observations Modal -->
    <div id="observationsModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2>📄 My Observation Materials</h2>
                <button class="modal-close" onclick="closeObservationsModal()">✕</button>
            </div>
            <div class="modal-content">
                <div id="observationsLoading" class="loading-message">
                    <div class="loading-spinner"></div>
                    <p>Loading your observations...</p>
                </div>
                <div id="observationsContent" style="display: none;">
                    <!-- Observations will be populated here -->
                </div>
                <div id="observationsEmpty" style="display: none;" class="empty-message">
                    <div class="empty-icon">📋</div>
                    <h3>No Observations Yet</h3>
                    <p>You don't have any finalized observations to view at this time.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Product Questions Modal -->
    <div id="workProductModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeWorkProductModalOnBackdrop(event)">
        <div style="position: relative; top: 5%; margin: 0 auto; width: 90%; max-width: 800px; background: white; border-radius: 8px; padding: 0; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; flex-shrink: 0;">
                <h2 style="margin: 0; color: #374151;">Work Product Reflection Questions</h2>
                <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 0.9rem;">Your responses are automatically saved as you type.</p>
            </div>
            <div id="questionsContainer" style="padding: 20px; overflow-y: auto; flex: 1; min-height: 0;"></div>
            <div style="padding: 15px 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; text-align: right; flex-shrink: 0;">
                <button onclick="closeWorkProductModal()" class="filter-btn">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
